# FAI vagrant image builder

This repository aims to build the Debian Vagrant base boxes available at 
https://app.vagrantup.com/debian
See that URL for the end user documentation.
This repository is based on https://salsa.debian.org/cloud-team/debian-cloud-images with the following Vagrant specific enhancements:

- priority based package selection: all packages with Priority Essential, Important, Standard are installed, to match the package selection done by the debian-installer
- generation of a standard OVF file for VirtualBox OVA import
- generation of package in box format, including a default Vagrantfile
- end to end test suite for VirtualBox and libvirt boxes (bare metal hardware is needed for running the test suite for VirtualBox)

## Getting started

You will need a checkout of this repository on your disk and a recent fai-server
package (at least 5.7) installed. Install the necessary fai packages without
the recommends (which avoids turning your host into a DHCP server!).
You also need python3-libcloud from Buster or newer.

```
  # git clone https://salsa.debian.org/cloud-team/debian-vagrant-images.git
  # sudo apt install --no-install-recommends ca-certificates debsums dosfstools \
    fai-server fai-setup-storage make python3 python3-libcloud python3-marshmallow \
    python3-pytest python3-yaml qemu-utils udev
```

  Call `make help` and follow the instructions

Example 1:

```
   # make bullseye-vagrant-amd64
```

This will create some log output and the following files:

- debian-bullseye-nocloud-amd64-official-20200421-1.build.json
- debian-bullseye-nocloud-amd64-official-20200421-1.info
- debian-bullseye-nocloud-amd64-official-20200421-1.raw
- debian-bullseye-nocloud-amd64-official-20200421-1.raw.tar

## Boxes creation

To convert the raw disk images into a usable vagrant box you will need
```
# apt install libxml-writer-perl libguestfs-perl uuid-runtime
```

## E2E tests
To run the end-to-end tests you will also need
```
apt install vagrant vagrant-libvirt virtualbox
```

Then if you call
```
make test-virtualbox-bullseye-vagrant-amd64
```
a box called virtualbox-debian-bullseye-vagrant-amd64-official-20200421-1.box
will be created in the current directory, and a test environment based on this box will run the e2e tests.

## Uploading boxes to Vagrant Cloud
To upload the boxes, you will need:
- the trickle package, which is a bandwidth usage limiter
- the VAGRANT_CLOUD_TOKEN set as an environment variable

Then if you call
```
   #  make NAMESPACE=debian IS_RELEASE=norelease upload-virtualbox-bullseye-vagrant-amd64
```
The box virtualbox-debian-bullseye-vagrant-amd64-official-20200421-1.box will be uploaded to 
'https://app.vagrantup.com/debian/', and you will have to release it manually on the app.vagrantup.com/debian/website

# Continuous Integration

Contact: Lucas Nussbaum <lucas@debian.org>

The CI pipeline configuration (`.gitlab-ci.yml`) is generated by a script. See `.gitlab-ci.yml.generator`

The CI pipeline runs on <https://www.grid5000.fr/>, which provides bare metal nodes for testing.

Most of the details are in scripts installed locally on a virtual machine (debvagrant-vm.lille.grid5000.fr).
Once you have been given access, connect using:
`ssh -J debvagrant@access.grid5000.fr root@debvagrant-vm.lille.grid5000.fr`

Then look into `/srv/ci-runner-scripts/bin/debvagrant` which should be easy to follow.

If you need an node for interactive usage, use `/srv/ci-runner-scripts/bin/debvagrant --get`

Note that due to [this bug](https://gitlab.com/gitlab-org/gitlab/-/issues/223012), the GitLab pipelines page is really hard to read. It is recommended to use [a custom CSS to work around this](https://bascht.com/tech/2020/11/18/better-gitlab-pipeline-ux-with-custom-css/)
